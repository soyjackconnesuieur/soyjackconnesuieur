name: Generate the soychive listings
on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Generate Directory Listings
        run: |
          python3 -c "
          import os

          ignore_list = ['.git', '.github']

          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if d not in ignore_list]
              if root == '.':
                  continue
              
              # HTML Content
              content = f'<html><body><h1>Index of {root}</h1><hr><ul>'
              
              # List Folders
              for d in dirs:
                  content += f'<li><a href=\'{d}/\'>{d}/</a></li>'
              
              # List Files
              for f in files:
                  if f != 'index.html':
                      content += f'<li><a href=\'{f}\'>{f}</a></li>'
                      
              content += '</ul></body></html>'
              
              # Write the file
              with open(os.path.join(root, 'index.html'), 'w') as f:
                  f.write(content)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "Soychives Bot"
          git config --global user.email "bot@noreply.github.com"
          git add .
          # The '|| echo' part prevents it from crashing if there's nothing new to save
          git commit -m "Update directory listings [skip ci]" || echo "No changes to commit"
          git push
